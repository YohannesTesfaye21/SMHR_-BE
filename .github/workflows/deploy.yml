name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    branches:
      - main
      - master
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            appsettings.Development.json

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -eo pipefail

            APP_DIR="/opt/smhfr-be"
            cd "$APP_DIR"
            
            # Debug: show directory contents
            echo "üìÅ Directory contents:"
            ls -la
            
            # Check if docker-compose.yml exists
            if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå docker-compose.yml not found!"
              echo "Looking for it..."
              find . -name "docker-compose.yml" 2>/dev/null
              exit 1
            fi

            # -----------------------------
            # 1Ô∏è‚É£ Write .env from secrets
            # -----------------------------
            {
              echo "DB_HOST=postgres"
              echo "DB_PORT=5432"
              echo "DB_NAME=smhfr_db"
              echo "DB_USER=postgres"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            } > .env
            chmod 600 .env

            echo "‚úÖ .env file created"
            echo "üìã .env contents (password masked):"
            sed 's/DB_PASSWORD=.*/DB_PASSWORD=***/' .env

            # -----------------------------
            # 2Ô∏è‚É£ Build and start all services
            # -----------------------------
            docker compose --env-file .env up -d --build
            
            # Show container status
            echo "üìä Container status:"
            docker compose ps

            # -----------------------------
            # 3Ô∏è‚É£ Wait for API to be healthy
            # -----------------------------
            echo "‚è≥ Waiting for API to be healthy..."
            sleep 30
            
            # Check if API container is running
            echo "üìä API container status:"
            docker compose ps api
            
            # Test postgres connectivity from API container
            echo "üîå Testing postgres connectivity:"
            docker compose exec -T postgres pg_isready -U postgres || echo "Postgres not ready"
            
            if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "‚úÖ API health check passed"
            else
              echo "‚ùå API health check failed"
              echo "=== API Logs ==="
              docker compose logs api --tail=100
              echo "=== Postgres Logs ==="
              docker compose logs postgres --tail=50
              exit 1
            fi

            echo "‚úÖ Deployment completed successfully!"
