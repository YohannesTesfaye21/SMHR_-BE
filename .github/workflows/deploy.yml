name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          overwrite: true
          rm: false
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            SERVER_FAILURE_ANALYSIS.md

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/smhfr-be
            export COMPOSE_PROJECT_NAME=smhfr-be
            
            # Create .env file
            cat > .env <<EOF
            DB_HOST=postgres
            DB_PORT=5432
            DB_NAME=smhfr_db
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF
            
            # Start postgres
            chmod +x docker-entrypoint-postgres.sh
            docker compose --env-file .env up -d postgres
            
            # Wait for postgres
            for i in {1..30}; do
              docker compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1 && break
              sleep 1
            done
            
            # Set password (persist it) - use PGPASSWORD for authentication
            PGPASSWORD='${{ secrets.DB_PASSWORD }}' docker compose exec -T -e PGPASSWORD='${{ secrets.DB_PASSWORD }}' postgres psql -U postgres -d postgres -c "ALTER USER postgres WITH PASSWORD '${{ secrets.DB_PASSWORD }}';" > /dev/null 2>&1 || {
              # If that fails, try without password (might be using trust auth initially)
              docker compose exec -T postgres psql -U postgres -d postgres -c "ALTER USER postgres WITH PASSWORD '${{ secrets.DB_PASSWORD }}';" > /dev/null 2>&1
            }
            
            # Terminate existing connections to force re-authentication with new password
            PGPASSWORD='${{ secrets.DB_PASSWORD }}' docker compose exec -T -e PGPASSWORD='${{ secrets.DB_PASSWORD }}' postgres psql -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'smhfr_db' AND pid <> pg_backend_pid();" > /dev/null 2>&1 || true
            
            # Wait for password change to take effect
            sleep 2
            
            # Stop API
            docker compose stop api 2>/dev/null || true
            
            # Apply database migrations
            # Pass connection string via environment variable to avoid shell escaping issues
            docker run --rm --network smhfr-be_smhfr-network \
              -v $(pwd):/src -w /src \
              -e ConnectionStrings__DefaultConnection="Host=postgres;Port=5432;Database=smhfr_db;Username=postgres;Password=${{ secrets.DB_PASSWORD }};Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;Command Timeout=30;Keepalive=30;Tcp Keepalive=true;SSL Mode=Disable" \
              mcr.microsoft.com/dotnet/sdk:8.0 sh -c "
                export PATH=\$PATH:/root/.dotnet/tools
                export ASPNETCORE_ENVIRONMENT=Production
                dotnet tool install --global dotnet-ef > /dev/null 2>&1
                dotnet nuget locals all --clear > /dev/null 2>&1 || true
                dotnet restore SMHFR_BE.csproj
                dotnet build SMHFR_BE.csproj -c Release --no-restore
                dotnet ef database update --project SMHFR_BE.csproj --no-build
              "
            
            # Start API
            docker volume rm smhfr-be_api_data 2>/dev/null || true
            docker compose --env-file .env up -d --no-deps api
            
            # Wait for API
            for i in {1..30}; do
              sleep 2
              if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "✅ Deployment successful"
                exit 0
              fi
            done
            
            echo "❌ API not accessible after 60 seconds"
            docker compose logs api --tail=50
            exit 1
