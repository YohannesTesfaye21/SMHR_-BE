name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    branches:
      - main
      - master
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            appsettings.Development.json

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -eo pipefail

            APP_DIR="/opt/smhfr-be"
            cd "$APP_DIR"

            # -----------------------------
            # 1️⃣ Write .env from secrets
            # -----------------------------
            {
              echo "DB_HOST=postgres"
              echo "DB_PORT=5432"
              echo "DB_NAME=smhfr_db"
              echo "DB_USER=postgres"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            } > .env
            chmod 600 .env

            echo "✅ .env file created"

            # -----------------------------
            # 2️⃣ Start Postgres first
            # -----------------------------
            docker compose --env-file .env up -d postgres

            echo "⏳ Waiting for Postgres to be healthy..."
            MAX_RETRIES=30
            RETRY=0
            until docker compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; do
              ((RETRY++))
              if [ $RETRY -ge $MAX_RETRIES ]; then
                echo "❌ Postgres failed to start"
                docker compose logs postgres --tail=50
                exit 1
              fi
              sleep 2
            done
            echo "✅ Postgres is ready"

            # -----------------------------
            # 3️⃣ Build and start API
            # -----------------------------
            docker compose build api
            docker compose --env-file .env up -d --no-deps --force-recreate api

            # -----------------------------
            # 4️⃣ Wait for API container and verify logs
            # -----------------------------
            echo "⏳ Waiting for API to start..."
            MAX_WAIT=20
            WAIT_COUNT=0
            until [ $WAIT_COUNT -ge $MAX_WAIT ]; do
              STATE=$(docker compose ps api --format json | grep -o '"State":"[^"]*"' | cut -d'"' -f4)
              if [ "$STATE" = "running" ]; then
                echo "✅ API container is running"
                break
              fi
              ((WAIT_COUNT++))
              sleep 2
            done

            if [ "$STATE" != "running" ]; then
              echo "❌ API failed to start"
              docker compose logs api --tail=50
              exit 1
            fi

            # -----------------------------
            # 5️⃣ Verify API health
            # -----------------------------
            echo "⏳ Waiting for API to be healthy..."
            MAX_HEALTH_RETRIES=30
            HEALTH_RETRY=0
            HEALTHY=false
            
            until [ $HEALTH_RETRY -ge $MAX_HEALTH_RETRIES ]; do
              if docker compose exec -T api curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
                HEALTHY=true
                echo "✅ API health check passed"
                break
              fi
              ((HEALTH_RETRY++))
              sleep 2
            done
            
            if [ "$HEALTHY" != "true" ]; then
              echo "❌ API health check failed"
              docker compose logs api --tail=100
              exit 1
            fi

            echo "✅ Deployment completed successfully!"
