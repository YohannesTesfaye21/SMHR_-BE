name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    branches:
      - main
      - master
    types:
      - completed
  workflow_dispatch:
    inputs:
      reset_database:
        description: 'Reset database (WARNING: deletes all data)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            appsettings.Development.json

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -eo pipefail

            APP_DIR="/opt/smhfr-be"
            cd "$APP_DIR"

            # -----------------------------
            # 1Ô∏è‚É£ Write .env from secrets
            # -----------------------------
            {
              echo "DB_HOST=postgres"
              echo "DB_PORT=5432"
              echo "DB_NAME=smhfr_db"
              echo "DB_USER=postgres"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            } > .env
            chmod 600 .env

            echo "‚úÖ .env file created"

            # -----------------------------
            # 2Ô∏è‚É£ Reset database (one-time fix)
            # -----------------------------
            echo "‚ö†Ô∏è Resetting database to fix password..."
            docker compose down -v

            # -----------------------------
            # 3Ô∏è‚É£ Start postgres
            # -----------------------------
            docker compose --env-file .env up -d postgres
            
            # Wait for postgres to be healthy
            echo "‚è≥ Waiting for Postgres..."
            sleep 10
            
            # -----------------------------
            # 4Ô∏è‚É£ Rebuild and restart API only
            # -----------------------------
            docker compose --env-file .env up -d --build --no-deps api
            
            # Show container status
            echo "üìä Container status:"
            docker compose ps

            # -----------------------------
            # 5Ô∏è‚É£ Wait for API to be healthy
            # -----------------------------
            echo "‚è≥ Waiting for API to be healthy..."
            sleep 30
            
            if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment completed successfully!"
            else
              echo "‚ùå API health check failed"
              docker compose logs --tail=50
              exit 1
            fi
