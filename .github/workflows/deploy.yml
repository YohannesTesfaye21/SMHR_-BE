name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          overwrite: true
          rm: false
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            SERVER_FAILURE_ANALYSIS.md

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/smhfr-be
            export COMPOSE_PROJECT_NAME=smhfr-be
            
            # Create .env file
            cat > .env <<EOF
            DB_HOST=postgres
            DB_PORT=5432
            DB_NAME=smhfr_db
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF
            
            # Start postgres
            chmod +x docker-entrypoint-postgres.sh
            docker compose --env-file .env up -d postgres
            
            # Wait for postgres
            for i in {1..30}; do
              docker compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1 && break
              sleep 1
            done
            
            # Set password (persist it)
            docker compose exec -T postgres psql -U postgres -d postgres -c "ALTER USER postgres WITH PASSWORD '${{ secrets.DB_PASSWORD }}';" > /dev/null 2>&1
            sleep 2
            
            # Stop API
            docker compose stop api 2>/dev/null || true
            
            # Run migrations
            DB_CONN="Host=postgres;Port=5432;Database=smhfr_db;Username=postgres;Password=${{ secrets.DB_PASSWORD }};Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;Command Timeout=30;Keepalive=30;Tcp Keepalive=true;SSL Mode=Disable"
            docker run --rm --network smhfr-be_smhfr-network -v $(pwd):/src -w /src mcr.microsoft.com/dotnet/sdk:8.0 sh -c "export PATH=\$PATH:/root/.dotnet/tools && export ASPNETCORE_ENVIRONMENT=Production && dotnet tool install --global dotnet-ef > /dev/null 2>&1 && dotnet restore SMHFR_BE.csproj > /dev/null 2>&1 && export ConnectionStrings__DefaultConnection='$DB_CONN' && dotnet ef database update --project SMHFR_BE.csproj" || {
              echo "Migration failed, checking if tables exist..."
              CHECK_STATUSES=$(docker compose exec -T postgres psql -U postgres -d smhfr_db -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_name='OperationalStatuses';" 2>/dev/null | tr -d '[:space:]' || echo "0")
              CHECK_OWNERSHIPS=$(docker compose exec -T postgres psql -U postgres -d smhfr_db -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_name='Ownerships';" 2>/dev/null | tr -d '[:space:]' || echo "0")
              
              if [ "$CHECK_STATUSES" != "1" ] || [ "$CHECK_OWNERSHIPS" != "1" ]; then
                echo "Tables missing. Checking migration history..."
                MIGRATION_EXISTS=$(docker compose exec -T postgres psql -U postgres -d smhfr_db -t -c "SELECT COUNT(*) FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\"='20260123184530_ConvertOwnershipAndOperationalStatusToLookupTables';" 2>/dev/null | tr -d '[:space:]' || echo "0")
                
                if [ "$MIGRATION_EXISTS" = "1" ]; then
                  echo "Migration in history but tables missing. Deleting history and re-running..."
                  docker compose exec -T postgres psql -U postgres -d smhfr_db -c "DELETE FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\"='20260123184530_ConvertOwnershipAndOperationalStatusToLookupTables';" 2>/dev/null || true
                fi
                
                echo "Re-running migrations..."
                docker run --rm --network smhfr-be_smhfr-network -v $(pwd):/src -w /src mcr.microsoft.com/dotnet/sdk:8.0 sh -c "export PATH=\$PATH:/root/.dotnet/tools && export ASPNETCORE_ENVIRONMENT=Production && dotnet tool install --global dotnet-ef > /dev/null 2>&1 && dotnet restore SMHFR_BE.csproj > /dev/null 2>&1 && export ConnectionStrings__DefaultConnection='$DB_CONN' && dotnet ef database update --project SMHFR_BE.csproj" || exit 1
              fi
            }
            
            # Start API
            docker volume rm smhfr-be_api_data 2>/dev/null || true
            docker compose --env-file .env up -d --no-deps api
            
            # Wait for API
            for i in {1..30}; do
              sleep 2
              if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "✅ Deployment successful"
                exit 0
              fi
            done
            
            echo "❌ API not accessible after 60 seconds"
            docker compose logs api --tail=50
            exit 1
