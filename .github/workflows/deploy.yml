name: Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "/opt/smhfr-be"
          overwrite: true
          rm: false
          strip_components: 0
          exclude: |
            .git
            .github
            **/bin
            **/obj
            **/.vs
            **/.vscode
            *.md
            SERVER_FAILURE_ANALYSIS.md

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/smhfr-be
            export COMPOSE_PROJECT_NAME=smhfr-be
            
            # Create .env file
            cat > .env <<EOF
            DB_HOST=postgres
            DB_PORT=5432
            DB_NAME=smhfr_db
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF
            
            # Start postgres
            chmod +x docker-entrypoint-postgres.sh
            docker compose --env-file .env up -d postgres
            
            # Wait for postgres
            for i in {1..30}; do
              docker compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1 && break
              sleep 1
            done
            
            # Set password (persist it)
            docker compose exec -T postgres psql -U postgres -d postgres -c "ALTER USER postgres WITH PASSWORD '${{ secrets.DB_PASSWORD }}';" > /dev/null 2>&1 || true
            
            # Wait for password change to take effect
            sleep 2
            
            # Verify password works before proceeding
            echo "Verifying database connection with new password..."
            PGPASSWORD='${{ secrets.DB_PASSWORD }}' docker compose exec -T -e PGPASSWORD='${{ secrets.DB_PASSWORD }}' postgres psql -U postgres -d smhfr_db -c "SELECT 1;" > /dev/null 2>&1 || {
              echo "Password verification failed, waiting longer..."
              sleep 3
              PGPASSWORD='${{ secrets.DB_PASSWORD }}' docker compose exec -T -e PGPASSWORD='${{ secrets.DB_PASSWORD }}' postgres psql -U postgres -d smhfr_db -c "SELECT 1;" || {
                echo "❌ Database connection verification failed"
                exit 1
              }
            }
            echo "✅ Database connection verified"
            
            # Stop API
            docker compose stop api 2>/dev/null || true
            
            # Verify migration files are present
            echo "=== Checking migration files on server ==="
            ls -la Migrations/ | head -20 || echo "Migrations directory not found"
            echo ""
            
            # Apply database migrations
            # Construct connection string inside container to avoid shell escaping issues
            docker run --rm --network smhfr-be_smhfr-network \
              -v $(pwd):/src -w /src \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              mcr.microsoft.com/dotnet/sdk:8.0 sh -c "
                export PATH=\$PATH:/root/.dotnet/tools
                export ASPNETCORE_ENVIRONMENT=Production
                export ConnectionStrings__DefaultConnection=\"Host=postgres;Port=5432;Database=smhfr_db;Username=postgres;Password=\$DB_PASSWORD;Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;Command Timeout=30;Keepalive=30;Tcp Keepalive=true;SSL Mode=Disable\"
                dotnet tool install --global dotnet-ef > /dev/null 2>&1
                dotnet nuget locals all --clear > /dev/null 2>&1 || true
                dotnet restore SMHFR_BE.csproj
                dotnet build SMHFR_BE.csproj -c Release --no-restore
                echo '=== Listing migrations EF Core sees ==='
                dotnet ef migrations list --project SMHFR_BE.csproj || true
                echo '=== Applying migrations ==='
                dotnet ef database update --project SMHFR_BE.csproj
              "
            
            # Rebuild and start API (rebuild to get latest code changes)
            docker volume rm smhfr-be_api_data 2>/dev/null || true
            docker compose --env-file .env build --no-cache api
            docker compose --env-file .env up -d --no-deps api
            
            # Wait for API
            for i in {1..30}; do
              sleep 2
              if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "✅ Deployment successful"
                exit 0
              fi
            done
            
            echo "❌ API not accessible after 60 seconds"
            docker compose logs api --tail=50
            exit 1
